<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Earth Simulator with NASA Meteor Presets</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Arial', sans-serif;
      background: #0a0a0a;
      color: #fff;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    .left-panel {
      flex: 1;
      position: relative;
      background: #000;
    }

    #earth-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .launch-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 15px 30px;
      background: linear-gradient(135deg, #ff4500, #ff6347);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 69, 0, 0.4);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .launch-btn:hover {
      background: linear-gradient(135deg, #ff6347, #ff7f50);
      box-shadow: 0 6px 20px rgba(255, 69, 0, 0.6);
      transform: translateY(-2px);
    }

    .launch-btn.disabled {
      background: linear-gradient(135deg, #666, #888);
      cursor: not-allowed;
      box-shadow: none;
    }

    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #1a1a1a;
      border-left: 2px solid #333;
      overflow-y: auto;
    }

    .map-header {
      background: #0d0d0d;
      padding: 20px;
      border-bottom: 2px solid #333;
    }

    .map-header h2 {
      font-size: 24px;
      color: #4fc3f7;
      margin-bottom: 10px;
    }

    .preset-section {
      padding: 20px;
      background: #151515;
      border-bottom: 2px solid #333;
    }

    .preset-section h3 {
      font-size: 16px;
      color: #ff6347;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .preset-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      padding: 5px;
    }

    .preset-card {
      background: rgba(42, 47, 64, 0.5);
      padding: 12px;
      border-radius: 6px;
      border: 1px solid rgba(79, 195, 247, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .preset-card:hover {
      background: rgba(79, 195, 247, 0.2);
      border-color: #4fc3f7;
      transform: translateY(-2px);
    }

    .preset-card.selected {
      background: rgba(79, 195, 247, 0.3);
      border-color: #4fc3f7;
      border-width: 2px;
    }

    .preset-name {
      font-size: 12px;
      font-weight: bold;
      color: #4fc3f7;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .preset-detail {
      font-size: 10px;
      color: #aaa;
      margin: 3px 0;
    }

    .preset-energy {
      font-size: 11px;
      color: #ff6347;
      font-weight: bold;
      margin-top: 5px;
    }

    .map-controls {
      padding: 20px;
      background: #151515;
      overflow-y: auto;
    }

    .control-group {
      background: rgba(42, 47, 64, 0.5);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid rgba(79, 195, 247, 0.3);
    }

    .control-group h3 {
      font-size: 13px;
      color: #4fc3f7;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .input-row label {
      font-size: 12px;
      color: #aaa;
      min-width: 70px;
    }

    .input-row input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #2a2f40;
      color: white;
      font-size: 13px;
    }

    .btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: linear-gradient(90deg, #2e4da7, #5f5fe0);
      color: white;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s ease;
      margin-top: 5px;
    }

    .btn:hover {
      background: linear-gradient(90deg, #4169e1, #7b7bff);
      box-shadow: 0 0 10px rgba(65,105,225,0.5);
    }

    .map-wrapper {
      flex: 1;
      position: relative;
      padding: 20px;
      min-height: 300px;
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid #333;
      cursor: crosshair;
    }

    .marker {
      background-color: #ff4444;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .location-status {
      background: rgba(79, 195, 247, 0.2);
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      font-size: 12px;
      color: #4fc3f7;
      margin: 15px 20px;
      border: 1px solid rgba(79, 195, 247, 0.4);
    }

    .selected-meteor-info {
      background: rgba(255, 99, 71, 0.2);
      padding: 15px;
      border-radius: 6px;
      margin: 15px 20px;
      border: 1px solid #ff6347;
    }

    .selected-meteor-info h4 {
      color: #ff6347;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .selected-meteor-info p {
      font-size: 11px;
      color: #ccc;
      margin: 5px 0;
    }

    @media (max-width: 1024px) {
      .container {
        flex-direction: column;
      }
      .left-panel, .right-panel {
        flex: none;
        height: 50vh;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <canvas id="earth-canvas"></canvas>
      <button class="launch-btn disabled" id="launch-btn" onclick="launchSimulation()">Launch Impact</button>
    </div>

    <div class="right-panel">
      <div class="map-header">
        <h2>NASA Meteor Impact Simulator</h2>
        <p>Select a real asteroid and target location</p>
      </div>

      <div class="preset-section">
        <h3>Select NASA Asteroid</h3>
        <div class="preset-grid" id="preset-grid"></div>
      </div>

      <div class="selected-meteor-info" id="meteor-info" style="display: none;">
        <h4>Selected Asteroid</h4>
        <p id="meteor-details"></p>
      </div>

      <div class="map-controls">
        <div class="control-group">
          <h3>Coordinates</h3>
          <div class="input-row">
            <label>Latitude:</label>
            <input type="number" id="lat" step="any" value="" placeholder="e.g. 39.907" />
          </div>
          <div class="input-row">
            <label>Longitude:</label>
            <input type="number" id="lng" step="any" value="" placeholder="e.g. 116.391" />
          </div>
          <button class="btn" onclick="goToCoordinates()">Go to Location</button>
        </div>

        <div class="control-group">
          <h3>Search Location</h3>
          <div class="input-row">
            <input type="text" id="location-search" placeholder="City, Country, or Landmark..." style="min-width: 100%;" />
          </div>
          <button class="btn" onclick="searchLocation()">Search</button>
        </div>
      </div>

      <div class="map-wrapper">
        <div id="map"></div>
      </div>

      <div class="location-status" id="location-status">
        Select an asteroid and target location to begin
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

  <script>
    // NASA Asteroid Data
    const nasaData = [{"diameter_m":217.7910249632,"energy_megatons":371.4889926818341,"id":"3427459","miss_distance_km":24264564.149475206,"name":"(2008 SS)","velocity_km_s":13.840886398},{"diameter_m":179.4898847799,"energy_megatons":91.16092403357881,"id":"3716631","miss_distance_km":23160725.07452431,"name":"(2015 HN9)","velocity_km_s":9.1642153983},{"diameter_m":56.7596852866,"energy_megatons":11.668174397471429,"id":"3720000","miss_distance_km":64538544.87798536,"name":"(2015 KT120)","velocity_km_s":18.4370903916},{"diameter_m":23.6613750114,"energy_megatons":0.20812610358167863,"id":"54201807","miss_distance_km":6508610.150578066,"name":"(2021 SY3)","velocity_km_s":9.1485908655},{"diameter_m":32.2136531891,"energy_megatons":0.2659989450184488,"id":"54212590","miss_distance_km":55059459.86577525,"name":"(2021 UJ1)","velocity_km_s":6.5107479995},{"diameter_m":241.0127281611,"energy_megatons":259.59268804290616,"id":"54300842","miss_distance_km":11782143.906704586,"name":"(2022 QG41)","velocity_km_s":9.9388733585},{"diameter_m":108.6525638621,"energy_megatons":19.81750484281751,"id":"54324411","miss_distance_km":13691349.622307826,"name":"(2022 VV)","velocity_km_s":9.0722584855},{"diameter_m":88.7237682527,"energy_megatons":129.61608968497802,"id":"54385247","miss_distance_km":58298111.214424714,"name":"(2023 SV1)","velocity_km_s":31.4427401601},{"diameter_m":616.6517648376,"energy_megatons":32556.774280567515,"id":"54417174","miss_distance_km":71709225.57956995,"name":"(2023 XJ16)","velocity_km_s":27.196412103},{"diameter_m":62.2357573367,"energy_megatons":1.166127955910243,"id":"54544998","miss_distance_km":7514832.23213637,"name":"(2025 RH2)","velocity_km_s":5.0764958157},{"diameter_m":701.5198735305,"energy_megatons":11601.214314616693,"id":"2247517","miss_distance_km":10842495.315741563,"name":"247517 (2002 QY6)","velocity_km_s":13.3795853397},{"diameter_m":765.6670867916,"energy_megatons":14699.791944646911,"id":"2319988","miss_distance_km":23753210.550295006,"name":"319988 (2007 DK)","velocity_km_s":13.2082877911},{"diameter_m":450.8582061718,"energy_megatons":7447.485981277271,"id":"54051291","miss_distance_km":22063999.767246377,"name":"(2020 QW2)","velocity_km_s":20.8063440814}];

    // State
    let selectedMeteor = null;
    let selectedLat = null;
    let selectedLng = null;
    let selectedLocationName = "";

    // 3D Earth Setup
    const canvas = document.getElementById('earth-canvas');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.1, 5000);
    camera.position.set(0, 50, 250);
    
    const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enablePan = false;
    const earthRadius = 100;
    controls.minDistance = earthRadius * 1.5;
    controls.maxDistance = 400;

    const stars = new THREE.Mesh(
      new THREE.SphereGeometry(3000, 64, 64),
      new THREE.MeshBasicMaterial({
        map: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/starfield.jpg"),
        side: THREE.BackSide
      })
    );
    scene.add(stars);

    const sunLight = new THREE.DirectionalLight(0xffffff, 1);
    sunLight.position.set(5, 3, 5);
    scene.add(sunLight);
    scene.add(new THREE.AmbientLight(0xffffff, 0.5));

    const earthGeometry = new THREE.SphereGeometry(earthRadius, 128, 128);
    const earthMaterial = new THREE.MeshPhongMaterial({
      map: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg"),
      specularMap: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/earth_specular_2048.jpg"),
      bumpMap: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/earth_bump_2048.jpg"),
      bumpScale: 0.3,
      side: THREE.FrontSide
    });
    const earth = new THREE.Mesh(earthGeometry, earthMaterial);
    scene.add(earth);

    let markerMesh = null;
    function createEarthMarker(lat, lng) {
      if (markerMesh) {
        earth.remove(markerMesh);
      }

      const markerGeometry = new THREE.SphereGeometry(3, 16, 16);
      const markerMaterial = new THREE.MeshBasicMaterial({ 
        color: 0xff4444,
        transparent: true,
        opacity: 0.9
      });
      markerMesh = new THREE.Mesh(markerGeometry, markerMaterial);

      const position = latLngToVector3(lat, lng, earthRadius + 1);
      markerMesh.position.copy(position);

      const glowGeometry = new THREE.SphereGeometry(4, 16, 16);
      const glowMaterial = new THREE.MeshBasicMaterial({
        color: 0xff8888,
        transparent: true,
        opacity: 0.3
      });
      const glow = new THREE.Mesh(glowGeometry, glowMaterial);
      markerMesh.add(glow);

      earth.add(markerMesh);
    }

    function latLngToVector3(lat, lng, radius) {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lng + 180) * (Math.PI / 180);
      const x = -(radius * Math.sin(phi) * Math.cos(theta));
      const z = (radius * Math.sin(phi) * Math.sin(theta));
      const y = (radius * Math.cos(phi));
      return new THREE.Vector3(x, y, z);
    }

    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
      .then(res => res.json())
      .then(worldData => {
        const countries = topojson.feature(worldData, worldData.objects.countries);
        const material = new THREE.LineBasicMaterial({ color: 0x00ff88, linewidth: 1 });

        countries.features.forEach(feature => {
          const coords = feature.geometry.coordinates;
          if (feature.geometry.type === "Polygon") {
            drawPolygon(coords);
          } else if (feature.geometry.type === "MultiPolygon") {
            coords.forEach(polygon => drawPolygon(polygon));
          }
        });

        function drawPolygon(polygon) {
          polygon.forEach(ring => {
            const points = [];
            ring.forEach(([lon, lat]) => {
              points.push(latLngToVector3(lat, lon, earthRadius + 0.1));
            });
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(geometry, material);
            earth.add(line);
          });
        }
      });

    function animate() {
      requestAnimationFrame(animate);
      earth.rotation.y += 0.001;
      
      if (markerMesh && markerMesh.children[0]) {
        const pulse = Math.sin(Date.now() * 0.003) * 0.1 + 0.3;
        markerMesh.children[0].material.opacity = pulse;
      }
      
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener("resize", () => {
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    });

    // Populate preset grid
    const presetGrid = document.getElementById('preset-grid');
    nasaData.forEach(meteor => {
      const card = document.createElement('div');
      card.className = 'preset-card';
      card.innerHTML = `
        <div class="preset-name" title="${meteor.name}">${meteor.name}</div>
        <div class="preset-detail">Diameter: ${meteor.diameter_m.toFixed(1)}m</div>
        <div class="preset-detail">Speed: ${meteor.velocity_km_s.toFixed(1)} km/s</div>
        <div class="preset-energy">${meteor.energy_megatons.toFixed(2)} MT</div>
      `;
      card.onclick = () => selectMeteor(meteor, card);
      presetGrid.appendChild(card);
    });

    function selectMeteor(meteor, cardElement) {
      selectedMeteor = meteor;
      
      document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('selected'));
      cardElement.classList.add('selected');
      
      document.getElementById('meteor-info').style.display = 'block';
      document.getElementById('meteor-details').innerHTML = `
        <strong>Name:</strong> ${meteor.name}<br>
        <strong>Diameter:</strong> ${meteor.diameter_m.toFixed(1)} meters<br>
        <strong>Velocity:</strong> ${meteor.velocity_km_s.toFixed(2)} km/s<br>
        <strong>Energy:</strong> ${meteor.energy_megatons.toFixed(2)} Megatons TNT
      `;
      
      updateLaunchButton();
    }

    // Map functionality
    const MAPTILER_KEY = '0GCZRo8V9UPQFhWV1vt6';
    let map;
    let marker = null;

    window.addEventListener('load', function() {
      map = new maplibregl.Map({
        container: 'map',
        style: `https://api.maptiler.com/maps/satellite/style.json?key=${MAPTILER_KEY}`,
        center: [0, 20],
        zoom: 2
      });

      map.setMaxBounds([[-179.999, -85], [179.999, 85]]);
      map.addControl(new maplibregl.NavigationControl(), 'top-right');

      map.on('click', function(e) {
        const { lng, lat } = e.lngLat;
        addMarker(lng, lat);
        selectedLocationName = 'Custom Location';
        document.getElementById('lat').value = lat.toFixed(6);
        document.getElementById('lng').value = lng.toFixed(6);
      });
    });

    function addMarker(lng, lat) {
      if (marker) marker.remove();

      const el = document.createElement('div');
      el.className = 'marker';
      marker = new maplibregl.Marker(el).setLngLat([lng, lat]).addTo(map);

      selectedLat = lat;
      selectedLng = lng;
      createEarthMarker(lat, lng);
      updateLaunchButton();
      updateLocationStatus();
    }

    function updateLaunchButton() {
      const btn = document.getElementById('launch-btn');
      if (selectedMeteor && selectedLat !== null && selectedLng !== null) {
        btn.classList.remove('disabled');
      } else {
        btn.classList.add('disabled');
      }
    }

    function updateLocationStatus() {
      const status = document.getElementById('location-status');
      if (selectedMeteor && selectedLat !== null) {
        status.innerHTML = `Ready to launch ${selectedMeteor.name} at (${selectedLat.toFixed(4)}, ${selectedLng.toFixed(4)})`;
      } else if (selectedMeteor) {
        status.innerHTML = `Asteroid selected. Please choose target location.`;
      } else if (selectedLat !== null) {
        status.innerHTML = `Location selected. Please choose an asteroid.`;
      }
    }

    function goToCoordinates() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);
      if (isNaN(lat) || isNaN(lng)) {
        alert('Please enter valid coordinates!');
        return;
      }
      if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
        alert('Invalid coordinates!');
        return;
      }
      addMarker(lng, lat);
      selectedLocationName = 'Custom Location';
      if (map) map.flyTo({ center: [lng, lat], zoom: 10, duration: 2000 });
    }

    async function searchLocation() {
      const query = document.getElementById('location-search').value.trim();
      if (!query) {
        alert('Please enter a location name!');
        return;
      }
      try {
        const response = await fetch(
          `https://api.maptiler.com/geocoding/${encodeURIComponent(query)}.json?key=${MAPTILER_KEY}`
        );
        const data = await response.json();
        if (data.features && data.features.length > 0) {
          const [lng, lat] = data.features[0].center;
          selectedLocationName = data.features[0].place_name || query;
          addMarker(lng, lat);
          if (map) {
            map.flyTo({
              center: [lng, lat],
              zoom: data.features[0].place_type[0] === 'country' ? 5 : 10,
              duration: 2000
            });
          }
          document.getElementById('lat').value = lat.toFixed(6);
          document.getElementById('lng').value = lng.toFixed(6);
        } else {
          alert('Location not found!');
        }
      } catch (error) {
        alert('Search failed!');
      }
    }

    document.getElementById('lat').addEventListener('keypress', e => {
      if (e.key === 'Enter') goToCoordinates();
    });
    document.getElementById('lng').addEventListener('keypress', e => {
      if (e.key === 'Enter') goToCoordinates();
    });
    document.getElementById('location-search').addEventListener('keypress', e => {
      if (e.key === 'Enter') searchLocation();
    });

    function launchSimulation() {
      if (!selectedMeteor || selectedLat === null || selectedLng === null) {
        alert('Please select both an asteroid and a target location!');
        return;
      }
      
      // Store all data for the simulation page
      sessionStorage.setItem('targetLat', selectedLat);
      sessionStorage.setItem('targetLng', selectedLng);
      sessionStorage.setItem('targetName', selectedLocationName);
      sessionStorage.setItem('meteorName', selectedMeteor.name);
      sessionStorage.setItem('meteorSpeed', selectedMeteor.velocity_km_s);
      sessionStorage.setItem('meteorMass', (selectedMeteor.diameter_m ** 3 * 2600).toFixed(0)); // Approximate mass
      sessionStorage.setItem('meteorDiameter', selectedMeteor.diameter_m);
      sessionStorage.setItem('meteorEnergy', selectedMeteor.energy_megatons);
      
      window.location.href = 'impact.html';
    }
  </script>
</body>
</html>